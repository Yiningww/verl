#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import numpy as np
import matplotlib.pyplot as plt

# ---------- 可调参数 ----------
TITLE = "Response Length vs Step"
OUTPUT = "response_length_vs_step.pdf"
FIGSIZE = (4, 2.5)
DPI = 220
SMOOTH_WINDOW = 1     # 移动平均窗口(奇数); 1 表示不平滑
XTICKS = [40, 80, 120, 160]
XMIN, XMAX = 0, 160   # 如需看全程，把 XMAX 改大或注释掉 set_xlim

def moving_average(x, w):
    x = np.asarray(x, float)
    if w <= 1:
        return x
    if w % 2 == 0:
        w += 1
    pad = w // 2
    xp = np.pad(x, (pad, pad), mode="reflect")
    ker = np.ones(w)/w
    return np.convolve(xp, ker, mode="valid")

# ---------- 你的数据 ----------
ours = [
616.7617188,617.8404541,665.4957275,656.9194336,647.8944092,725.2908936,725.5026855,701.1833496,702.7124023,716.5480957,
706.425293,702.3137207,686.3911133,709.7548828,700.2581787,701.3364258,691.4592285,701.1668701,690.6162109,699.2506104,
691.3144531,685.0397949,699.3859863,703.1079102,703.2624512,673.8795166,689.5791016,690.0916748,689.2346191,683.9693604,
677.381958,684.9232178,697.4986572,697.8758545,671.0581055,676.2611084,667.4589844,688.0909424,682.1278076,669.6739502,
688.8582764,674.2974854,685.6651611,688.8258057,667.5916748,679.8552246,676.321167,693.6450195,688.5844727,675.7279053,
672.9155273,691.2176514,702.1269531,674.7106934,675.3032227,663.9693604,666.5351563,671.6896973,674.3393555,690.0366211,
681.4056396,682.7973633,667.1854248,673.6794434,668.012207,696.9742432,653.4906006,660.4613037,683.6026611,673.4779053,
677.7713623,680.6369629,680.8952637,672.4259033,670.3094482,664.5720215,656.9659424,669.7491455,672.498291,665.3764648,
679.3312988,676.4002686,655.973999,672.8377686,655.4168701,651.4945068,655.2608643,665.5192871,663.8347168,654.6813965,
671.8883057,647.8643799,671.6474609,674.1644287,667.1375732,659.274292,647.7600098,669.677002,665.8491211,662.1572266,
658.0767822,680.6328125,651.3980713,660.1376953,656.3493652,662.4755859,656.2913818,657.2659912,666.5672607,669.9334717,
667.3131104,658.2174072,666.3647461,656.0739746,666.7845459,662.345459,667.8354492,650.9643555,668.5924072,674.2834473,
673.5063477,660.0479736,671.7857666,668.9732666,666.4038086,678.8006592,663.8111572,666.223877,671.9940186,661.8482666,
667.6540527,673.7580566,676.5773926,670.2412109,655.5721436,662.862915,669.7144775,663.7606201,664.44104,661.0408936,
657.5723877,663.4642334,677.0646973,680.4085693,673.3469238,667.1324463,673.8015137,661.2445068,666.0013428,656.611084,
671.923584,663.3857422,666.6713867,672.3123779,666.5206299,655.5404053,671.1218262,660.630127
]

token_mean = [
616.7617188,623.6704102,665.7075195,657.3375244,663.1938477,724.460083,740.1257324,709.1875,715.9643555,720.104126,
713.828125,698.4674072,691.8970947,707.1414795,699.0749512,704.4145508,698.3914795,702.8023682,692.9359131,698.5897217,
692.6707764,696.1719971,698.0031738,711.9907227,711.4476318,684.387085,700.3190918,701.1505127,696.9265137,694.9377441,
689.2406006,697.2746582,709.7827148,707.0460205,685.2403564,688.9344482,682.0639648,701.1853027,694.0256348,682.9367676,
696.3378906,693.1481323,692.1204834,694.8535156,674.9890747,701.6481934,685.1147461,693.7905273,681.1563721,686.1239014,
679.9920654,687.8291016,682.6550293,682.6096191,689.4244385,700.3806152,701.175293,667.9095459,685.9301758,688.3562012,
687.0187988,680.0754395,678.2990723,684.0413818,695.0969238,692.4699707,666.5421143,680.8428955,669.5904541,692.9188232,
685.1213379,668.8248291,688.916748,667.9705811,688.5817871,691.3393555,660.8753662,673.4882813,679.7023926,688.9295654,
688.1275635,676.7236328,669.3659668,684.7246094,696.6069336,667.9379883,677.6368408,661.7355957,662.5889893,672.0196533,
672.8157959,687.3043213,676.9553223,675.171875,664.4154053,675.8798828,662.8664551,692.7924805,651.5236816,658.5581055,
681.5125732,672.2597656,677.7253418,680.1936035,678.0351563,668.0981445,669.145752,667.7381592,654.645752,668.605835,
677.1699219,669.1029053,675.9820557,682.901001,662.9993896,670.7966309,660.0527344,651.5548096,657.295166,667.418457,
668.1860352,657.4682617,674.1047363,651.2281494,667.9726563,669.052124,667.7211914,657.8547363,643.432251,668.0070801,
661.5654297,659.5894775,661.2115479,682.0532227,653.6253662,660.6296387,657.5360107,658.5112305,656.7264404,655.1422119,
670.3165283,668.8515625,667.041748,659.5611572,674.6181641,660.911377,668.2980957,661.5941162,671.2336426,654.6190186,
663.6112061,676.4458008,664.4611816,651.1695557,667.6689453,661.6629639,663.2177734,673.2094727
]

seq_mean_token_mean = [
616.7617188,622.4736328,667.9301758,674.9002686,698.5924072,896.3905029,948.1558838,961.3665771,942.25354,952.5209961,
927.5836182,926.0189209,902.111084,875.6795654,836.6147461,805.9853516,785.0081787,764.9934082,742.2052002,745.8354492,
734.428833,729.192749,735.2536621,739.5898438,740.2965088,702.2156982,726.3276367,719.4797363,720.3449707,721.1000977,
712.6555176,719.2556152,730.3820801,728.8737793,706.3742676,712.4390869,702.4953613,726.5421143,713.2674561,697.5701904,
719.7723389,703.6563721,709.1938477,723.829834,691.6166992,699.3192139,708.9975586,710.6611328,717.6259766,698.2579346,
693.2497559,713.2368164,724.7817383,698.3898926,699.2686768,693.2376709,694.7701416,708.3409424,702.4066162,715.34729,
708.9355469,707.2679443,686.0441895,700.9038086,689.5526123,719.4178467,673.4505615,686.7376709,703.2446289,696.7658691,
702.0999756,703.8952637,699.4836426,693.1247559,688.2800293,681.8526611,675.0877686,686.0777588,697.803833,681.6469727,
694.0571289,698.5469971,678.3908691,691.5487061,679.3288574,669.4436035,677.7122803,688.5241699,693.3240967,681.7541504,
691.8499756,664.9348145,691.6689453,698.1096191,683.4735107,682.8161621,668.3562012,692.9658203,691.4853516,697.3088379,
687.1671143,709.6845703,681.7370605,692.378418,682.7258301,690.8336182,686.4788818,691.9067383,696.6428223,703.3800049,
694.1634521,683.9509277,688.489624,677.9152832,687.3203125,678.692627,688.4938965,669.8192139,688.9433594,696.5878906,
691.4820557,674.8419189,682.7398682,686.0235596,685.2216797,693.7615967,675.0843506,678.2397461,686.5600586,676.0328369,
682.9481201,689.0895996,688.2314453,690.0844727,666.6049805,679.7189941,676.4857178,680.6520996,679.9472656,676.6881104,
667.8515625,670.0804443,686.298584,696.284668,691.3212891,681.4871826,690.7531738,672.684082,680.8927002,666.8214111,
684.206543,675.0012207,678.1761475,677.7683105,678.2431641,663.7084961,679.427124,666.3710938
]

# ---------- 生成 step ----------
N = min(len(ours), len(token_mean), len(seq_mean_token_mean))
x = np.arange(N, dtype=float)

# 可选平滑
ours_s = moving_average(ours[:N], SMOOTH_WINDOW)
tm_s   = moving_average(token_mean[:N], SMOOTH_WINDOW)
seq_s  = moving_average(seq_mean_token_mean[:N], SMOOTH_WINDOW)
x_s    = x[:len(ours_s)]   # 与平滑后长度对齐(当 SMOOTH_WINDOW>1 时)

# ---------- 画图 ----------
plt.rcParams.update({
    "axes.spines.top": False,
    "axes.spines.right": False,
    "axes.titlesize": 12,
    "axes.labelsize": 10,
    "xtick.labelsize": 9,
    "ytick.labelsize": 9,
    "legend.fontsize": 9,
})

fig, ax = plt.subplots(figsize=FIGSIZE)

l1, = ax.plot(x_s, ours_s, color="tab:red",   linewidth=1.8, label="ours")
l2, = ax.plot(x_s, tm_s,   color="tab:blue",  linewidth=1.8, label="token-mean")
l3, = ax.plot(x_s, seq_s,  color="tab:green", linewidth=1.8, label="seq-mean-token-mean")

# ax.set_title(TITLE)
ax.set_xlabel("Step")
ax.set_ylabel("Response Length")

# 只显示指定的 x 轴刻度，并限制可视范围
ax.set_xlim(XMIN, XMAX)
ax.set_xticks([t for t in XTICKS if XMIN <= t <= XMAX])

ax.grid(True, linestyle="--", linewidth=0.6, alpha=0.35)

# 图例放到上方留白，单列
lines = [l1, l2, l3]
labels = [ln.get_label() for ln in lines]
ax.legend(lines, labels, frameon=False, ncol=1, loc="upper right")

plt.tight_layout()
# plt.savefig(OUTPUT, dpi=DPI, bbox_inches="tight")
plt.savefig("3b-response-length.pdf")
print(f"Saved: {OUTPUT}")
