#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import numpy as np
import matplotlib.pyplot as plt

# ===== 可调参数 =====
TITLE = "Entropy vs Step (Zoom 80–160)"
OUTPUT = "3b-entropy.pdf"
FIGSIZE = (4, 2.5)
DPI = 220
SMOOTH_WINDOW = 1         # 移动平均窗口(奇数); 1 表示不平滑
AMP = 8.0                 # 放大 (ours - token_mean) 的系数
XMIN, XMAX = 80, 160      # 放大窗口

# ===== 你的数据 =====
N_POINTS = 158
step = list(range(N_POINTS))

ours = [
    0.683519781, 0.642404258, 0.639232576, 0.560905457, 0.537067711, 0.446852922, 0.403316975, 0.375742555,
    0.330033153, 0.288049757, 0.284875304, 0.252731591, 0.228526637, 0.221753284, 0.203516245, 0.190057158,
    0.176874682, 0.170888036, 0.169888049, 0.163248494, 0.162908792, 0.146856651, 0.147597040, 0.141758040,
    0.145282164, 0.146809936, 0.136462420, 0.133285567, 0.131198406, 0.130075946, 0.131579772, 0.126481488,
    0.125690043, 0.124271221, 0.116339520, 0.118582040, 0.115987286, 0.113209046, 0.113483004, 0.106593050,
    0.108404614, 0.108085401, 0.101627879, 0.099032596, 0.100733012, 0.093973108, 0.097440362, 0.094023347,
    0.091089100, 0.089292072, 0.087503038, 0.088094093, 0.085358910, 0.084759928, 0.076564901, 0.083445899,
    0.079831764, 0.078266218, 0.076852664, 0.075335667, 0.078848362, 0.073898174, 0.073806271, 0.069597423,
    0.071851812, 0.072219595, 0.070594594, 0.069452606, 0.068207383, 0.065151751, 0.068482228, 0.066023760,
    0.065928929, 0.063092582, 0.063411072, 0.063384764, 0.061070442, 0.060752649, 0.062812008, 0.059610873,
    0.058487173, 0.057810016, 0.059607957, 0.058778118, 0.057178896, 0.057037078, 0.054181416, 0.056250922,
    0.054774079, 0.055008363, 0.053280979, 0.052714743, 0.051134732, 0.052062817, 0.052370995, 0.051646024,
    0.049045894, 0.051012143, 0.049510598, 0.049190030, 0.049047053, 0.045767896, 0.048212819, 0.048125193,
    0.045745518, 0.046712190, 0.047610644, 0.047676317, 0.046134006, 0.045521345, 0.043362819, 0.044255544,
    0.043834273, 0.043054007, 0.043608677, 0.042602502, 0.042318907, 0.042328335, 0.042338926, 0.042489532,
    0.041072965, 0.041202299, 0.039876524, 0.039932247, 0.040474236, 0.039905481, 0.040442657, 0.039513644,
    0.037724491, 0.038818177, 0.038939614, 0.038718637, 0.038129259, 0.038341638, 0.037319891, 0.036945790,
    0.036573429, 0.037546590, 0.037708163, 0.035235457, 0.035756376, 0.036159299, 0.035789479, 0.035603218,
    0.036015630, 0.034464806, 0.035147619, 0.033859257, 0.035330910, 0.033815663, 0.034476925, 0.033849280,
    0.034262143, 0.033755269, 0.034742456, 0.033082757, 0.034028672, 0.034105662
]

token_mean = [
    0.683519781, 0.671595752, 0.616959274, 0.573529363, 0.543232679, 0.444920301,
    0.404339701, 0.376100808, 0.347911626, 0.300189525, 0.284636974, 0.250462025,
    0.21562323, 0.213524207, 0.21392487, 0.180550545, 0.174903989, 0.174631193,
    0.170011595, 0.167849287, 0.157399341, 0.150718167, 0.153900847, 0.148182362,
    0.149821073, 0.144659951, 0.141733617, 0.136107251, 0.133564636, 0.133409724,
    0.129351526, 0.132500425, 0.124107607, 0.124365538, 0.123850472, 0.120956458,
    0.119242541, 0.119814426, 0.118118405, 0.110008784, 0.111876175, 0.104699701,
    0.105453666, 0.1007789, 0.100957517, 0.099574432, 0.099774249, 0.092596687,
    0.093162462, 0.094192378, 0.087796375, 0.089777283, 0.085981593, 0.083038226,
    0.081961401, 0.082393937, 0.081912979, 0.077633351, 0.075036868, 0.074583709,
    0.073156595, 0.071432561, 0.071297236, 0.068708293, 0.067923926, 0.067229629,
    0.068284079, 0.069279753, 0.065696813, 0.065853894, 0.063028216, 0.061525699,
    0.063955903, 0.060549565, 0.059186183, 0.060694229, 0.058285285, 0.058269102,
    0.059729476, 0.058830168, 0.058412179, 0.055975039, 0.056822069, 0.056838244,
    0.055652056, 0.055987183, 0.051182274, 0.054699458, 0.052548651, 0.052608509,
    0.051659409, 0.048804868, 0.052591804, 0.050235249, 0.049250297, 0.047957942,
    0.048421703, 0.049668789, 0.04810537, 0.047956534, 0.045579616, 0.046652313,
    0.047533922, 0.044584025, 0.04594145, 0.043318879, 0.045240384, 0.044482667,
    0.042943001, 0.042930134, 0.044845194, 0.041200079, 0.041894551, 0.041443333,
    0.041876312, 0.042467076, 0.040443301, 0.0400212, 0.038554344, 0.040667888,
    0.040044487, 0.039594404, 0.039659381, 0.039000168, 0.038046714, 0.038992219,
    0.037684821, 0.039937712, 0.037809063, 0.03813044, 0.037854549, 0.037521601,
    0.03732476, 0.037319548, 0.036674369, 0.035963736, 0.034784466, 0.035881318,
    0.037574869, 0.036386095, 0.034539368, 0.035235088, 0.033263326, 0.03378414,
    0.032792218, 0.033790935, 0.034128819, 0.033163689, 0.032416165, 0.032834128,
    0.033052165, 0.03243126, 0.032099944, 0.032525647, 0.031320345, 0.03172477,
    0.031434748, 0.031773861
]

# ===== 工具函数 =====
def moving_average(x, w):
    x = np.asarray(x, float)
    if w <= 1:
        return x
    if w % 2 == 0:
        w += 1
    pad = w // 2
    xp = np.pad(x, (pad, pad), mode="reflect")
    ker = np.ones(w) / w
    return np.convolve(xp, ker, mode="valid")

# ===== 数据与窗口选择 =====
x = np.asarray(step, float)
y1 = moving_average(ours, SMOOTH_WINDOW)
y2 = moving_average(token_mean, SMOOTH_WINDOW)

mask = (x >= XMIN) & (x <= XMAX)
xw  = x[mask]
y1w = y1[mask]
y2w = y2[mask]
diff = (y1w - y2w) * AMP

# ===== 样式 =====
plt.rcParams.update({
    "axes.spines.top": False,
    "axes.titlesize": 12,
    "axes.labelsize": 10,
    "xtick.labelsize": 9,
    "ytick.labelsize": 9,
    "legend.fontsize": 9,
})

fig, ax1 = plt.subplots(figsize=FIGSIZE)

# 主曲线
l1, = ax1.plot(xw, y1w, color="tab:red",  linewidth=1.8, label="ours")
l2, = ax1.plot(xw, y2w, color="tab:blue", linewidth=1.8, label="token-mean")

# 差异阴影
ax1.fill_between(xw, y1w, y2w, where=(y1w >= y2w), color="tab:red",  alpha=0.12, linewidth=0)
ax1.fill_between(xw, y1w, y2w, where=(y1w <  y2w), color="tab:blue", alpha=0.12, linewidth=0)

# 副轴：放大后的差值，纵轴按窗口内幅度自适应
# ax2 = ax1.twinx()
# m = max(np.nanpercentile(np.abs(diff), 99), 1e-6)
# ax2.set_ylim(-m*1.1, m*1.1)
# l3, = ax2.plot(xw, diff, color="black", linestyle="--", linewidth=1.2, label=f"Δ × {AMP:g}")
# ax2.set_ylabel(f"Amplified Δ (×{AMP:g})")

# 轴标题/范围/刻度
# ax1.set_title(TITLE)
ax1.set_xlabel("Step")
ax1.set_ylabel("Entropy")
ax1.set_xlim(XMIN, XMAX)
ax1.set_xticks([80, 100, 120, 140, 160])

# y 轴按窗口自适应并加一点边距
ymin = min(y1w.min(), y2w.min()); ymax = max(y1w.max(), y2w.max())
pad = 0.05 * (ymax - ymin if ymax > ymin else 1.0)
ax1.set_ylim(ymin - pad, ymax + pad)

ax1.grid(True, linestyle="--", linewidth=0.6, alpha=0.35)

# 合并图例放上方
lines = [l1, l2]
labels = [ln.get_label() for ln in lines]
# ax1.legend(lines, labels, frameon=False, ncol=3,
#            bbox_to_anchor=(0.0, 1.02, 1.0, 0.2), loc="lower left",
#            mode="expand", borderaxespad=0.0, handlelength=2.0)
ax1.legend(lines, labels, ncol=1, loc="upper right")


plt.tight_layout()
# plt.savefig(OUTPUT, dpi=DPI, bbox_inches="tight")
plt.savefig("3b-entropy.pdf")
print(f"Saved: {OUTPUT}")


